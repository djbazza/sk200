[gcode_macro M600]
default_parameter_B: 2   ; Number of beeps to alert user
default_parameter_X: 50  ; X position for filament change
default_parameter_Y:  5  ; Y position for filament change
default_parameter_Z: 10  ; Z relative lift for filament change position
gcode:
   {% if (B | int) <= 0 %}
      { printer.gcode.action_respond_info("Parameter 'B' must be greater than zero") }
   {% else %}
        SAVE_GCODE_STATE NAME=M600_state
        PAUSE
        M83
        G91
        G1 E-0.8 F2700
        G1 Z{Z}
        G90
        G1 X{X} Y{Y} F3000
        {% for i in range(B | int) %}
            M300 P100 S1000
            {% if (B | int) > 1 %}G4 P100{% endif %}
        {% endfor %}
        G91
        G1 E-50 F300
        RESTORE_GCODE_STATE NAME=M600_state
   {% endif %}
