[gcode_macro UNLOAD_FILAMENT]
gcode:
   {% if (printer.toolhead.status == "Ready" or printer.pause_resume.is_paused) %}
      SAVE_GCODE_STATE NAME=UNLOAD_state
      M83                            ; set extruder to relative
      G1 E-10 F300                   ; short retract
      G4 P5000                       ; wait for filament to cool
      G1 E10 F300                    ; quick purge
      G1 E-150 F1200                 ; retract all filament
      RESTORE_GCODE_STATE NAME=UNLOAD_state
   {% else %}
      { printer.gcode.action_respond_info("Filament unloading disabled while printing!") }
   {% endif %}